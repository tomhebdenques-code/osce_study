<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quesmed OSCE AI | Intelligent Clinical Practice</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Dark Mode (Quesmed Style) */
            --bg-body: #0F172A;
            --bg-sidebar: #1E293B;
            --bg-card: #1E293B;
            --bg-input: #334155;
            --text-main: #F8FAFC;
            --text-muted: #cdd8e6;
            --primary: #3B82F6; /* Quesmed Blue */
            --primary-hover: #2563EB;
            --accent-success: #10B981;
            --accent-danger: #EF4444;
            --accent-warning: #F59E0B;
            --border: #334155;
            --bubble-user: #3B82F6;
            --bubble-ai: #334155;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Light Mode Override */
        [data-theme="light"] {
            --bg-body: #F1F5F9;
            --bg-sidebar: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-input: #F1F5F9;
            --text-main: #0F172A;
            --text-muted: #64748B;
            --primary: #2563EB;
            --border: #E2E8F0;
            --bubble-user: #2563EB;
            --bubble-ai: #F1F5F9;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 320px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
            transition: background-color 0.3s ease;
        }

        .brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-main);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* REPLACE THE OLD .brand-logo BLOCK WITH THIS */
        .brand-logo {
            width: 35px;       /* Adjust size as needed */
            height: auto;      /* Maintains aspect ratio */
            margin-right: 10px;
            object-fit: contain;
            display: block;    /* Ensures it sits correctly in the flex container */
            background: none;  /* IMPORTANT: Removes the blue square background */
            border-radius: 0;  /* Removes rounded corners */
        }

        .search-bar {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 14px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.9rem;
            width: 100%;
        }

        .category-header {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin: 15px 0 8px 5px;
            font-weight: 600;
        }

        .station-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .station-card {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .station-card:hover {
            background: var(--bg-input);
            color: var(--text-main);
        }

        .station-card.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--primary);
            border-color: rgba(59, 130, 246, 0.3);
            font-weight: 600;
        }

        .user-panel {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 50%;
            transition: color 0.2s;
        }
        .theme-toggle:hover { color: var(--text-main); }

        /* --- MAIN STAGE --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .hud {
            height: 70px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 10;
        }

        .hud-title {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .timer-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--bg-card);
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .timer-digits {
            font-family: 'Inter', monospace;
            font-variant-numeric: tabular-nums;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-main);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
        }
        .status-dot.paused { background: var(--accent-warning); }
        .status-dot.critical { background: var(--accent-danger); animation: pulse 1s infinite; }

        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.5;} 100% {opacity: 1;} }

        .btn-control {
            border: none;
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-control:hover { opacity: 0.9; }
        .btn-control.secondary { background: var(--bg-input); color: var(--text-main); }
        .btn-control.danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-danger); }

        /* --- CHAT AREA --- */
        #chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .msg {
            max-width: 75%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
        }

        .msg.user {
            align-self: flex-end;
            background: var(--bubble-user);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg.ai {
            align-self: flex-start;
            background: var(--bubble-ai);
            color: var(--text-main);
            border-bottom-left-radius: 4px;
        }

        .typing {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-left: 20px;
            margin-bottom: 10px;
            display: none;
            font-style: italic;
        }

        /* --- INPUT --- */
        .input-area {
            padding: 24px 30px;
            background: var(--bg-body);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        input[type="text"] {
            flex-grow: 1;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            font-family: inherit;
        }
        input[type="text"]:focus { border-color: var(--primary); }
        input[type="text"]:disabled { opacity: 0.6; cursor: not-allowed; }

        .btn-send {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.1s;
        }
        .btn-send:active { transform: scale(0.95); }
        .btn-send:disabled { background: var(--bg-input); color: var(--text-muted); cursor: not-allowed; }

        /* --- OVERLAYS --- */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-body);
            z-index: 50;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: slideUp 0.3s ease-out;
            padding: 40px;
            overflow-y: auto;
        }

        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .result-card {
            background: var(--bg-card);
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }

        .score-circle {
            width: 120px; height: 120px;
            border-radius: 50%;
            border: 8px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; font-weight: 800;
            margin: 0 auto 20px auto;
            color: var(--text-main);
        }

        .rubric-list {
            text-align: left;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
            border-top: 1px solid var(--border);
            padding-top: 20px;
        }

        .rubric-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .rubric-item.completed { color: var(--text-main); }
        .tag { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; font-weight: 600; }
        .tag.success { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        .tag.missed { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }

        /* --- MODAL --- */
        .modal-bg {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 16px;
            width: 350px;
            text-align: center;
            border: 1px solid var(--border);
            color: var(--text-main);
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand">
        <img src="{{ url_for('static', filename='quesmed_logo.png') }}" alt="Quesmed Logo" class="brand-logo">
        Quesmed OSCE AI
    </div>
    
    <input type="text" class="search-bar" placeholder="Search scenarios..." onkeyup="filterStations(this.value)">

    <div class="station-list" id="station-list-container">
        </div>

    <div class="user-panel">
        <div style="font-size:0.85rem; color:var(--text-muted);">
            Logged in as <strong style="color:var(--text-main);">Student</strong>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
            üåó
        </button>
    </div>
</div>

<div class="main-content">
    <div class="hud">
        <div class="hud-title" id="active-station-name">Welcome</div>
        
        <div class="timer-container">
            <button class="btn-control secondary" id="pause-btn" onclick="togglePause()" style="padding:4px 10px; height:30px; display:none;">‚è∏</button>
            <div class="status-dot" id="timer-dot"></div>
            <span class="timer-digits" id="timer-display">08:00</span>
        </div>

        <button class="btn-control danger" onclick="endStation()" id="end-btn" style="display:none;">End Station</button>
    </div>

    <div id="chat-container">
        <div style="text-align:center; color:var(--text-muted); margin-top:100px;">
            <div style="font-size:3rem; margin-bottom:20px;">ü©∫</div>
            <h3>Select a station to begin</h3>
            <p>Choose from 50+ AI-powered OSCE scenarios in the sidebar.</p>
        </div>
    </div>
    
    <div class="typing" id="typing-indicator">Patient is typing...</div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Type your question here..." disabled oninput="handleTyping()" onkeydown="if(event.key==='Enter') sendMessage()">
        <button class="btn-send" id="send-btn" onclick="sendMessage()" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
    </div>

    <div id="viva-overlay" class="overlay">
        <div class="result-card">
            <h2 style="margin-bottom:10px;">Viva Voce</h2>
            <p style="color:var(--text-muted); margin-bottom:30px;">Answer the examiner's questions.</p>
            
            <div style="background:var(--bg-input); padding:20px; border-radius:12px; margin-bottom:20px; text-align:left;">
                <strong style="color:var(--primary);">Examiner asks:</strong>
                <div id="viva-question-text" style="margin-top:10px; font-size:1.1rem;">Loading...</div>
            </div>

            <input type="text" id="viva-input" placeholder="Type answer..." style="width:100%; margin-bottom:20px;">
            <button class="btn-control" onclick="submitViva()" style="width:100%;">Submit Answer</button>
        </div>
    </div>

    <div id="result-overlay" class="overlay">
        <div class="result-card">
            <div class="score-circle" id="final-score">--</div>
            <h2 id="final-grade-text" style="margin-bottom:20px;">PASS</h2>
            
            <div style="text-align:left; background:var(--bg-input); padding:15px; border-radius:12px; margin-bottom:20px;">
                <strong>Examiner Feedback:</strong>
                <p id="final-feedback" style="margin-top:5px; color:var(--text-muted); font-size:0.9rem;">--</p>
            </div>

            <div class="rubric-list" id="result-breakdown"></div>
            
            <button class="btn-control" onclick="location.reload()" style="margin-top:20px; width:100%;">Next Station</button>
        </div>
    </div>
</div>

<div class="modal-bg" id="timer-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:15px;">‚è± Set Timer</h3>
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:25px;">
            <input type="number" id="minutes-input" value="8" style="width:70px; text-align:center;">
            <span>:</span>
            <input type="number" id="seconds-input" value="0" style="width:70px; text-align:center;">
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-control secondary" onclick="document.getElementById('timer-modal').style.display='none'" style="flex:1;">Cancel</button>
            <button class="btn-control" onclick="startStationActual()" style="flex:1;">Start</button>
        </div>
    </div>
</div>

<script>
    // --- STATE ---
    let scenarios = {{ scenarios | tojson }};
    let currentScenarioId = null;
    let chatHistory = [];
    let vivaQuestions = [];
    let vivaResponses = [];
    let vivaIndex = 0;
    
    let historyScore = 0;
    let historyFeedback = "";
    
    let timeLeft = 480;
    let timerId = null;
    let timerPaused = false;
    let typingTimeout = null;
    let isTyping = false;

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        renderStationList(scenarios);
        
        // Auto Dark Mode check
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            document.documentElement.setAttribute('data-theme', 'light');
        }
    });

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
    }

    function renderStationList(list) {
        const container = document.getElementById('station-list-container');
        container.innerHTML = '';
        
        // Group by prefix (simple categorization)
        const categories = {};
        list.forEach(s => {
            const prefix = s.id.split('_')[0].toUpperCase();
            if (!categories[prefix]) categories[prefix] = [];
            categories[prefix].push(s);
        });

        for (const [cat, stations] of Object.entries(categories)) {
            const header = document.createElement('div');
            header.className = 'category-header';
            header.innerText = cat === 'OG' ? 'OBS & GYNAE' : cat; // Rename OG shorthand
            container.appendChild(header);

            stations.forEach(s => {
                const el = document.createElement('div');
                el.className = 'station-card';
                el.innerText = s.name;
                el.onclick = () => selectStation(s.id, s.name, el);
                container.appendChild(el);
            });
        }
    }

    function filterStations(query) {
        const lower = query.toLowerCase();
        const filtered = scenarios.filter(s => s.name.toLowerCase().includes(lower) || s.id.toLowerCase().includes(lower));
        renderStationList(filtered);
    }

    // --- LOGIC ---

    function selectStation(id, name, el) {
        document.querySelectorAll('.station-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        
        currentScenarioId = id;
        document.getElementById('active-station-name').innerText = name;
        document.getElementById('timer-modal').style.display = 'flex';
    }

    function startStationActual() {
        const mins = parseInt(document.getElementById('minutes-input').value) || 8;
        const secs = parseInt(document.getElementById('seconds-input').value) || 0;
        timeLeft = (mins * 60) + secs;
        
        document.getElementById('timer-modal').style.display = 'none';
        document.getElementById('chat-container').innerHTML = '<div style="text-align:center; color:var(--text-muted); margin-top:20px; font-size:0.9rem;">Station Started. Timer Running.</div>';
        
        chatHistory = [];
        document.getElementById('user-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        document.getElementById('end-btn').style.display = 'block';
        document.getElementById('pause-btn').style.display = 'block';
        document.getElementById('user-input').focus();

        clearInterval(timerId);
        timerPaused = false;
        updateTimerDisplay();
        timerId = setInterval(tick, 1000);
    }

    function tick() {
        if (!timerPaused && !isTyping && timeLeft > 0) {
            timeLeft--;
            updateTimerDisplay();
        } else if (timeLeft <= 0) {
            clearInterval(timerId);
            endStation();
        }
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60);
        const s = timeLeft % 60;
        document.getElementById('timer-display').innerText = `${m}:${s.toString().padStart(2, '0')}`;
        
        const dot = document.getElementById('timer-dot');
        dot.className = 'status-dot';
        if (timerPaused || isTyping) dot.classList.add('paused');
        if (timeLeft < 30) dot.classList.add('critical');
    }

    function togglePause() {
        timerPaused = !timerPaused;
        document.getElementById('pause-btn').innerText = timerPaused ? '‚ñ∂' : '‚è∏';
        updateTimerDisplay();
    }

    function handleTyping() {
        isTyping = true;
        updateTimerDisplay();
        if (typingTimeout) clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            isTyping = false;
            updateTimerDisplay();
        }, 1000);
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const txt = input.value.trim();
        if (!txt) return;

        isTyping = false;
        input.value = '';
        addMessage(txt, 'user');
        chatHistory.push({"role": "user", "content": txt});
        
        document.getElementById('typing-indicator').style.display = 'block';

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ scenario_id: currentScenarioId, history: chatHistory })
            });
            const data = await res.json();
            
            document.getElementById('typing-indicator').style.display = 'none';
            addMessage(data.content, 'ai');
            chatHistory.push({"role": "assistant", "content": data.content});
        } catch (e) {
            console.error(e);
            addMessage("Connection Error", 'ai');
        }
    }

    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.innerText = text;
        const container = document.getElementById('chat-container');
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    async function endStation() {
        clearInterval(timerId);
        document.getElementById('user-input').disabled = true;
        
        try {
            const res = await fetch('/grade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ scenario_id: currentScenarioId, history: chatHistory })
            });
            const data = await res.json();
            historyScore = data.score;
            historyFeedback = data.feedback;
            
            // Populate breakdown early
            const list = document.getElementById('result-breakdown');
            list.innerHTML = '<h4>Checklist Breakdown</h4>';
            data.items.forEach(i => {
                list.innerHTML += `
                    <div class="rubric-item ${i.completed ? 'completed' : ''}">
                        <span>${i.item}</span>
                        <span class="tag ${i.completed ? 'success' : 'missed'}">${i.completed ? 'DONE' : 'MISSED'}</span>
                    </div>`;
            });

            startViva();
        } catch (e) {
            alert('Error grading');
        }
    }

    async function startViva() {
        const res = await fetch('/get_viva', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ scenario_id: currentScenarioId })
        });
        const data = await res.json();
        vivaQuestions = data.questions;
        if (vivaQuestions.length) {
            document.getElementById('viva-overlay').style.display = 'flex';
            showNextViva();
        } else {
            finalizeSession(0, "No Viva");
        }
    }

    function showNextViva() {
        if (vivaIndex < vivaQuestions.length) {
            document.getElementById('viva-question-text').innerText = vivaQuestions[vivaIndex].q;
            document.getElementById('viva-input').value = "";
            document.getElementById('viva-input').focus();
        } else {
            finishViva();
        }
    }

    function submitViva() {
        vivaResponses.push(document.getElementById('viva-input').value);
        vivaIndex++;
        showNextViva();
    }

    async function finishViva() {
        document.getElementById('viva-overlay').innerHTML = '<div style="text-align:center;"><h2>Grading Answers...</h2></div>';
        
        const res = await fetch('/grade_viva', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ scenario_id: currentScenarioId, responses: vivaResponses })
        });
        const data = await res.json();
        finalizeSession(data.score, data.feedback);
    }

    async function finalizeSession(vScore, vFeedback) {
        document.getElementById('viva-overlay').style.display = 'none';
        document.getElementById('result-overlay').style.display = 'flex';

        const res = await fetch('/final_assessment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                scenario_id: currentScenarioId,
                h_score: historyScore, h_feedback: historyFeedback,
                v_score: vScore, v_feedback: vFeedback,
                history: chatHistory, viva_responses: vivaResponses
            })
        });
        const final = await res.json();

        document.getElementById('final-score').innerText = final.score + "%";
        document.getElementById('final-grade-text').innerText = final.grade;
        document.getElementById('final-grade-text').style.color = final.color;
        document.getElementById('final-feedback').innerText = `History: ${historyFeedback} | Viva: ${vFeedback}`;
        
        // Update Ring Colour
        const ring = document.getElementById('final-score');
        ring.style.borderColor = final.color;
    }
</script>

</body>
</html>