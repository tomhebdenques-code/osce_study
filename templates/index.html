<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCE AI | Clinical Excellence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7c4dff;
            --primary-glow: rgba(124, 77, 255, 0.3);
            --bg: #0b0b0e;
            --card: #16161d;
            --border: #2a2a35;
            --text: #ffffff;
            --text-dim: #a0a0ab;
            --success: #00e676;
            --error: #ff5252;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { width: 100%; max-width: 1000px; padding: 40px 20px; display: flex; flex-direction: column; }

        /* --- LANDING & TIMER SETUP --- */
        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 2.5rem; letter-spacing: -1px; }
        h1 span { color: var(--primary); }
        
        .setup-section { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 30px; text-align: center; }
        .timer-input-group { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; }
        .timer-input-group input { 
            width: 70px; text-align: center; font-size: 1.5rem; background: #000; 
            border: 1px solid var(--border); color: var(--primary); border-radius: 10px; padding: 10px; 
            font-weight: 700; font-family: monospace;
        }

        .station-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .station-card { 
            background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid var(--border); 
            cursor: pointer; transition: 0.3s; position: relative;
        }
        .station-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .station-card.active { border-color: var(--primary); background: rgba(124, 77, 255, 0.05); box-shadow: 0 0 20px var(--primary-glow); }
        .station-card h3 { margin: 0 0 10px 0; }
        .station-card p { color: var(--text-dim); font-size: 0.9rem; margin: 0; }

        /* --- CHAT INTERFACE --- */
        #chat-interface { display: none; height: 85vh; flex-direction: column; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        
        #timer-display { font-family: monospace; font-size: 2rem; font-weight: 700; color: var(--primary); transition: 0.3s; }
        .timer-controls { display: flex; align-items: center; gap: 15px; }

        #chat-box { 
            flex-grow: 1; overflow-y: auto; background: rgba(255, 255, 255, 0.02); 
            border: 1px solid var(--border); border-radius: 24px; padding: 25px; 
            display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; 
        }
        .msg { padding: 14px 20px; border-radius: 20px; max-width: 75%; font-size: 0.95rem; line-height: 1.5; }
        .user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        .ai { align-self: flex-start; background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }

        .input-wrapper { display: flex; gap: 12px; background: var(--card); padding: 12px; border-radius: 18px; border: 1px solid var(--border); }
        .input-wrapper input { flex-grow: 1; background: transparent; border: none; color: white; padding: 5px 10px; outline: none; font-size: 1rem; }
        
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-finish { background: #2a1a1a; color: #ff5252; border: 1px solid #4a2a2a; }

        /* --- RESULTS --- */
        #result-box { display: none; text-align: center; animation: fadeIn 0.5s ease; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: left; margin-top: 30px; }
        .result-section { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid var(--border); }
        .rubric-pill { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) { .results-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div id="selection-screen">
        <header>
            <h1>OSCE AI<span> by Quesmed</span></h1>
            <p style="color:var(--text-dim)">Adjust your settings and choose a station to begin.</p>
        </header>

        <div class="setup-section">
            <label style="font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">Station Duration</label>
            <div class="timer-input-group">
                <input type="number" id="setup-min" value="08" min="0" max="59">
                <span style="font-size: 1.5rem; font-weight: bold;">:</span>
                <input type="number" id="setup-sec" value="00" min="0" max="59">
            </div>
        </div>
        
        <div class="station-grid">
            {% for s in scenarios %}
            <div class="station-card" onclick="selectStation('{{ s.id }}', '{{ s.name }}', this)">
                <div style="font-size: 0.7rem; color: var(--primary); font-weight: 700; text-transform: uppercase; margin-bottom: 5px;">Active Station</div>
                <h3>{{ s.name }}</h3>
                <p>Simulated clinical history encounter.</p>
            </div>
            {% endfor %}
        </div>
        
        <div style="text-align:center">
            <button class="btn btn-primary" onclick="startStation()" style="width: 100%; max-width: 300px; font-size: 1.1rem; padding: 16px;">Begin Consultation</button>
        </div>
    </div>

    <div id="chat-interface">
        <div class="chat-header">
            <h2 id="station-title" style="margin:0">Station</h2>
            <div class="timer-controls">
                <div id="timer-display">00:00</div>
                <button id="pause-btn" class="btn" style="background:#2a2a35" onclick="toggleTimer()">Pause</button>
                <button class="btn btn-finish" onclick="finishExam()">Finish</button>
            </div>
        </div>
        <div id="chat-box"></div>
        <div class="input-wrapper">
            <input type="text" id="user-input" placeholder="Type your response here..." 
                   oninput="handleTyping()" 
                   onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="btn btn-primary" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <div id="result-box">
        <div style="margin-bottom: 20px;">
            <p style="color:var(--text-dim); margin:0; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px;">Result Summary</p>
            <h1 id="score-text" style="font-size: 5rem; margin: 0; line-height: 1;">0%</h1>
        </div>

        <div class="results-grid">
            <div class="result-section">
                <h4 style="margin-top:0; color:var(--primary)">Checklist Performance</h4>
                <div id="rubric-list"></div>
            </div>
            <div class="result-section">
                <h4 style="margin-top:0; color:var(--primary)">Examiner Feedback</h4>
                <div id="feedback-content" style="color:var(--text-dim); line-height:1.6; white-space: pre-wrap;"></div>
            </div>
        </div>
        <br>
        <div style="display:flex; gap:10px; justify-content: center;">
            <button class="btn btn-primary" onclick="location.reload()">Start New Session</button>
            <button class="btn" style="background: #2a2a35" onclick="window.print()">Download PDF</button>
        </div>
    </div>
</div>

<script>
    let chatHistory = [];
    let currentScenarioId = "";
    let timeLeft = 0;
    let timerId = null;
    let isPaused = false;
    let typingTimeout = null;

    function selectStation(id, name, el) {
        currentScenarioId = id;
        document.querySelectorAll('.station-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('station-title').innerText = name;
    }

    function startStation() {
        if (!currentScenarioId) return alert("Please select a station card first!");
        
        const mins = parseInt(document.getElementById('setup-min').value) || 0;
        const secs = parseInt(document.getElementById('setup-sec').value) || 0;
        timeLeft = (mins * 60) + secs;

        if (timeLeft <= 0) return alert("Set a duration greater than 0!");

        document.getElementById('selection-screen').style.display = 'none';
        document.getElementById('chat-interface').style.display = 'flex';
        
        appendMsg("System: Consultation started. The timer is active.", "ai");
        runTimer();
    }

    /* SMART TIMER LOGIC */
    function runTimer() {
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
            if (!isPaused) {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    alert("Time is up! The session will now be graded.");
                    finishExam();
                }
            }
        }, 1000);
    }

    function handleTyping() {
        pauseTimer();
        clearTimeout(typingTimeout);
        // Resume timer after 2 seconds of inactivity
        typingTimeout = setTimeout(() => {
            resumeTimer();
        }, 2000);
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
        const s = (timeLeft % 60).toString().padStart(2, '0');
        const display = document.getElementById('timer-display');
        display.innerText = `${m}:${s}`;
        
        // Visual Feedback for Pause
        display.style.opacity = isPaused ? "0.4" : "1";
        
        if (timeLeft < 30) display.style.color = 'var(--error)';
        else display.style.color = 'var(--primary)';
    }

    function toggleTimer() { isPaused ? resumeTimer() : pauseTimer(); }
    function pauseTimer() { 
        isPaused = true; 
        document.getElementById('pause-btn').innerText = "Play"; 
        updateTimerDisplay();
    }
    function resumeTimer() { 
        isPaused = false; 
        document.getElementById('pause-btn').innerText = "Pause"; 
        updateTimerDisplay();
    }

    /* COMMUNICATION LOGIC */
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text) return;

        // Reset typing timeout and resume clock immediately
        clearTimeout(typingTimeout);
        resumeTimer();

        appendMsg(text, 'user');
        chatHistory.push({role: 'user', content: text});
        input.value = "";

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({history: chatHistory, scenario_id: currentScenarioId})
            });
            const data = await res.json();
            chatHistory.push(data);
            appendMsg(data.content, 'ai');
        } catch (e) {
            appendMsg("Error: Connection lost.", "ai");
        }
    }

    function appendMsg(text, role) {
        const box = document.getElementById('chat-box');
        box.innerHTML += `<div class="msg ${role}">${text}</div>`;
        box.scrollTop = box.scrollHeight;
    }

    async function finishExam() {
        clearInterval(timerId);
        clearTimeout(typingTimeout);
        document.getElementById('chat-interface').style.display = 'none';
        document.getElementById('result-box').style.display = 'block';
        document.getElementById('score-text').innerText = "Grading...";

        try {
            const res = await fetch('/grade', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({history: chatHistory, scenario_id: currentScenarioId})
            });
            const data = await res.json();
            
            document.getElementById('score-text').innerText = data.score + "%";
            document.getElementById('score-text').style.color = data.score > 70 ? 'var(--success)' : 'white';
            document.getElementById('feedback-content').innerText = data.feedback;

            let rubricHtml = data.items.map(i => `
                <div class="rubric-pill">
                    <span style="max-width:80%">${i.item}</span>
                    <span>${i.completed ? '✅' : '❌'}</span>
                </div>
            `).join('');
            document.getElementById('rubric-list').innerHTML = rubricHtml;
        } catch (e) {
            document.getElementById('score-text').innerText = "Error";
        }
    }
</script>
</body>
</html>